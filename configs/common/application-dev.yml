# ========================================
# Config Server - 개발 환경 전용 설정 (application-dev.yml)
# H2 인메모리 데이터베이스 및 개발 편의 기능 활성화
# 우선순위: application-dev.yml > gateway-server.yml
# ========================================

spring:
  # ===== H2 데이터베이스 설정 (PostgreSQL 오버라이드) =====
  datasource:
    # H2 인메모리 데이터베이스 URL
    # mem: 인메모리 모드
    # DB_CLOSE_DELAY=-1: JVM 종료시까지 데이터 유지
    # DB_CLOSE_ON_EXIT=FALSE: 연결 종료시 DB 유지
    # MODE=PostgreSQL: PostgreSQL 호환 모드
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=PostgreSQL
    driver-class-name: org.h2.Driver  # H2 드라이버
    username: sa  # H2 기본 사용자
    password:  # 비밀번호 없음 (개발용)

    # HikariCP 설정 (개발 환경용으로 축소)
    hikari:
      connection-timeout: 10000  # 연결 타임아웃 10초
      maximum-pool-size: 5  # 최대 풀 크기 축소
      minimum-idle: 2  # 최소 유휴 연결 축소
      idle-timeout: 300000  # 5분
      max-lifetime: 600000  # 10분

  # ===== H2 Console 설정 =====
  # 웹 브라우저에서 H2 데이터베이스 조회/수정 가능
  h2:
    console:
      enabled: true  # H2 웹 콘솔 활성화
      path: /h2-console  # 접속 경로: http://localhost:${APP_PORT}/h2-console
      settings:
        trace: false  # SQL 트레이스 비활성화
        web-allow-others: true  # 원격 접속 허용 (주의: 개발용만!)

  # ===== JPA/Hibernate 개발 설정 =====
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect  # H2 방언 사용
    hibernate:
      ddl-auto: create-drop  # 애플리케이션 시작시 테이블 생성, 종료시 삭제
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect
        format_sql: true  # SQL 포맷팅 활성화
        use_sql_comments: true  # SQL 주석 표시
        show_sql: false  # 콘솔에 SQL 출력 (로그로 대체)
        default_schema:  # H2는 스키마 미지원
        generate_statistics: true  # 통계 정보 생성 (성능 분석용)
    show-sql: false  # SQL 로깅으로 대체
    defer-datasource-initialization: true  # data.sql 실행 지연 (스키마 생성 후)

  # ===== SQL 초기화 스크립트 =====
  sql:
    init:
      mode: always  # 항상 초기화 스크립트 실행
      platform: h2  # H2 플랫폼용 스크립트 사용
      # schema-locations: classpath:schema-h2.sql  # 스키마 스크립트 위치
      # data-locations: classpath:data-h2.sql  # 데이터 스크립트 위치

    # ===== Kafka 메시징 설정 =====
  kafka:
    # Kafka 브로커 클러스터 주소
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092,localhost:9093,localhost:9094}

    # ----- Producer(생산자) 설정 -----
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer  # 키 직렬화
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer  # 값 직렬화 (JSON)
      acks: all  # 모든 복제본 확인 (최고 신뢰성)
      retries: 3  # 전송 실패 시 재시도 횟수
      properties:
        enable.idempotence: true  # 멱등성 보장 (중복 방지)
        max.in.flight.requests.per.connection: 5  # 동시 전송 가능한 요청 수

    # ----- Consumer(소비자) 설정 -----
    consumer:
      group-id: ${KAFKA_CONSUMER_GROUP_ID:${spring.application.name}-group}  # 컨슈머 그룹 ID
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer  # 키 역직렬화
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer  # 값 역직렬화 (JSON)
      auto-offset-reset: earliest  # 오프셋 리셋 정책 (처음부터 읽기)
      enable-auto-commit: false  # 수동 커밋 모드 (트랜잭션 보장)
      properties:
        spring.json.trusted.packages: "*"  # 모든 패키지 신뢰 (역직렬화 허용)
        isolation.level: read_committed  # 커밋된 메시지만 읽기 (트랜잭션 지원)

    # ----- Listener 설정 -----
    listener:
      ack-mode: manual  # 수동 승인 모드 (메시지 처리 보장)
      concurrency: 3  # 동시 처리 리스너 수

  # ===== Spring Cloud 개발 설정 =====
  cloud:
    # Config Server 설정
    config:
      fail-fast: false  # Config Server 없어도 시작 가능
      retry:
        max-attempts: 1  # 재시도 최소화 (빠른 시작)

    # Stream 설정 (개발용)
    stream:
      kafka:
        binder:
          auto-create-topics: true  # 토픽 자동 생성
          replication-factor: 1  # 단일 복제 (로컬 개발)
          min-partition-count: 1  # 최소 파티션
      bindings:
        input:
          consumer:
            concurrency: 1  # 단일 스레드 처리
        output:
          producer:
            partition-count: 1  # 단일 파티션

  # ===== 보안 설정 (개발 환경) =====
  security:
    # 개발 환경에서는 보안 간소화 또는 비활성화
    oauth2:
      resourceserver:
        jwt:
          # 개발용 Mock JWT 또는 비활성화
          issuer-uri: ${KEYCLOAK_ISSUER_URI:}  # 비어있으면 비활성화

# ===== 로깅 설정 (개발 환경) =====
logging:
  level:
    # 개발 환경에서 상세 로깅
    com.earlyexpress: DEBUG  # 자체 패키지 디버그
    org.springframework: DEBUG  # Spring 프레임워크 디버그
    org.springframework.web: DEBUG  # Spring Web 디버그
    org.springframework.cloud: DEBUG  # Spring Cloud 디버그
    org.springframework.kafka: DEBUG  # Kafka 디버그
    org.hibernate.SQL: DEBUG  # Hibernate SQL 로깅
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE  # SQL 파라미터 로깅
    org.hibernate.stat: DEBUG  # Hibernate 통계
    feign: DEBUG  # Feign 클라이언트 디버그
    com.netflix: DEBUG  # Netflix 컴포넌트 디버그
  pattern:
    # 개발용 로그 패턴 (컬러 출력)
    console: "%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%thread]){cyan} %clr(%-5level) %clr(%logger{36}){magenta} - %msg%n"
  file:
    name: logs/${spring.application.name}-dev.log
    max-size: 5MB  # 파일 크기 축소
    max-history: 7  # 보관 기간 축소

# ===== Actuator 설정 (개발 환경) =====
management:
  endpoints:
    web:
      exposure:
        # 개발 환경에서는 모든 엔드포인트 노출
        include: "*"
  endpoint:
    health:
      show-details: always
      show-components: always
    env:
      enabled: true  # 환경 변수 확인 가능
    configprops:
      enabled: true  # 설정 속성 확인 가능
    beans:
      enabled: true  # Bean 목록 확인 가능
    mappings:
      enabled: true  # 매핑 정보 확인 가능
  trace:
    http:
      enabled: true  # HTTP 트레이스 활성화

  # 개발 환경에서는 트레이싱 비율 낮춤
  tracing:
    sampling:
      probability: ${TRACING_PROBABILITY:0.1}  # 10% 샘플링

# ===== Resilience4j 설정 (개발 환경) =====
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 3  # 윈도우 크기 축소
        minimumNumberOfCalls: 1  # 최소 호출 수
        failureRateThreshold: 70  # 실패율 임계값 상향 (개발시 관대함)
        waitDurationInOpenState: 3s  # 대기 시간 단축

  retry:
    configs:
      default:
        maxAttempts: 2  # 재시도 축소
        waitDuration: 500ms  # 대기 시간 단축

  ratelimiter:
    configs:
      default:
        limitForPeriod: 100  # 제한 완화
        limitRefreshPeriod: 1s

# ===== WebClient 설정 (개발 환경) =====
webclient:
  timeout:
    # 디버깅을 위해 타임아웃 연장
    connection: ${WEBCLIENT_CONNECTION_TIMEOUT:10000}  # 10초
    read: ${WEBCLIENT_READ_TIMEOUT:30000}  # 30초
    write: ${WEBCLIENT_WRITE_TIMEOUT:30000}  # 30초
  connection-provider:
    max-connections: 50  # 연결 수 축소
    max-idle-time: 10s
    max-life-time: 30s

# ===== 개발 환경 전용 설정 =====
debug: true  # Spring Boot 디버그 모드 활성화

# ===== 개발 데이터 초기화 =====
# src/main/resources/data-h2.sql 파일 예시:
# INSERT INTO users (id, username, email) VALUES
#   (1, 'testuser1', 'test1@example.com'),
#   (2, 'testuser2', 'test2@example.com');

# ===== 개발 환경 Feature Flags =====
features:
  enable-mock-data: true  # Mock 데이터 사용
  enable-debug-endpoints: true  # 디버그 엔드포인트 활성화
  enable-sql-logging: true  # SQL 로깅 활성화
  enable-request-logging: true  # 요청/응답 로깅 활성화